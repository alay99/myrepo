---
title: "Project1"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Alay Shah aas4449

**Introduction**

*The title of my project is Exploring Relationship between Wealth and Public Education in the United States.*

*The two datasets I've chosen are statesinfo, which has information about public high school education for each state and us_rent_income dataset, which has data about average income and rent of a household in each state.*

*The statesinfo dataset contains 8 variables: X:(state), region, pop: population of high school students who took SAT, SATV: S.A.T. verbal score, SATM: S.A.T math score, percent(percentage of graduating high school students who take S.A.T), dollars(state spending on public education in $1000 per student), pay:(average teachers salary). This dataset was acquired through CSV file of online data.The us_rent_income dataset contains 5 variables: GEOID, Name:(State), variable (rent or income), estimated average of that variable, and MOE(margin of error). This data was acquired from the all package function built in r from 1995.*


*These two datasets are interesting to me because Im curious to see how high school education effectiveness in a state is related to its overall wealth. Im also excited to see potential associations between the two datasets when matched on state, for example if you're raised in a particular state with a better education system, is it possible to predict your overall wealth(rent&income) in life, given that you did not move.*



```{r cars}


data(package= .packages(all.available = TRUE))

#install.packages("tidyr")
library(tidyr)
data("us_rent_income")

#imported read csv file into data frame statesinfo
statesinfo <- read.csv("C:\\Users\\amana\\OneDrive\\Documents\\SDS348\\Projects\\statesinfo.csv", header = TRUE)


```
**Tidy**

```{r}
#statesinfo dataset was already tidy
#used pivot wider on us_rent_income only since there were multiple observ.(rent and income) of variable and they could be organized into their own column
us_rent_income1 <- us_rent_income%>%pivot_wider(names_from = variable, names_glue = "{variable}_{.value}", values_from = c(estimate,moe))
us_rent_income1
```

**Join/Merge**

```{r}
library(tidyverse)
# renamed columns appropriately to state to allow for left join. Used left join to match on the fifty states +district of Columbia and dropped Puerto Rico, which was in us_rent_income dataset; it isnt considered a US state, had missing values for income, and its info was not provided in statesinfo dataset
#dropped GEOID from us_rent_income upon join since it didnt have meaningful info. 
us_rent_income1 <- us_rent_income1 %>% rename(state= "NAME")
statesdata <- statesinfo %>% rename(state= "X") %>% left_join(us_rent_income1[,c(-1)], "state")
statesdata
```

**Summary Statistics**

```{r}
library(dplyr)

#Used 6 dplyr functions 

#I was interested in exploring Texas metrics and other border states. Below shows filtering for only western south central states and arranging by percent(percentage of graduating high school students who take S.A.T)
#As expected, Texas compared to other states in the region who a significantly higher percentage 
statesdata %>% filter(region =="WSC") %>% arrange(desc(percent))

#used group_by on regions within US and found mean rent estimate of those regions
statesdata %>% group_by(region) %>% summarize(mean_rent_stimate = mean(rent_estimate)) 

#used mutate to make a new column for average SAT Score
statesdata <- statesdata %>% mutate(SAT_avg = (SATV+SATM)/2)

#used select for particular columns and arranged from incr. to decr. SAT avg; wanted to see if there was a direct relationship to income_estimate and pay
statesdata %>% select(state, income_estimate, SAT_avg, pay) %>%  arrange(desc(SAT_avg))





#Next I began calculating summary statistics for my numeric variables overall and after grouping with my categorical variable region. A correlation matrix was made for the numerical variables

#Summary Statistics of population
statesdata %>% 
  summarize(mean_pop = mean(pop), 
            sd_pop = sd(pop),
            var= var(pop),
            IQR = IQR(pop), 
            n_rows = n(),
            quants = quantile(pop, probs=c(.1, .25, .5, .75, .90)),
            min = min(pop),
            max= max(pop),
            n_pop = n_distinct(pop)) 
#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD population per region
pop_data_grouped<- statesdata %>% 
  group_by(region)%>%
  summarize(mean_pop = mean(pop), 
            sd_pop = sd(pop),
            var_pop= var(pop),
            IQR = IQR(pop), 
            n_rows = n(),
            quant_50_pop = quantile(pop, probs=c(0.5)),
            min = min(pop),
            max= max(pop),
            n_pop = n_distinct(pop))

#Summary Statistics of SAT Verbal score
statesdata %>% 
  summarize(mean_SATV = mean(SATV), 
            sd_SATV = sd(SATV),
            var= var(SATV),
            IQR = IQR(SATV), 
            n_rows = n(),
            quants = quantile(SATV, probs=c(.1, .25, .5, .75, .90)),
            min = min(SATV),
            max= max(SATV),
            n_SATV = n_distinct(SATV)) 
#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD SAT Verbal score per region
SATV_data_grouped<- statesdata %>% 
  group_by(region)%>%
  summarize(mean_SATV = mean(SATV), 
            sd_SATV = sd(SATV),
            var_SATV= var(SATV),
            IQR = IQR(SATV), 
            n_rows = n(),
            quant_50_SATV = quantile(SATV, probs=c(0.5)),
            min = min(SATV),
            max= max(SATV),
            n_SATV = n_distinct(SATV))
#Summary Statistics of SAT Math score
statesdata %>% 
  summarize(mean_SATM = mean(SATM), 
            sd_SATM = sd(SATM),
            var= var(SATM),
            IQR = IQR(SATM), 
            n_rows = n(),
            quants = quantile(SATM, probs=c(.1, .25, .5, .75, .90)),
            min = min(SATM),
            max= max(SATM),
            n_SATV = n_distinct(SATM)) 
#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD SAT Math score per region
SATM_data_grouped<- statesdata %>% 
  group_by(region)%>%
  summarize(mean_SATM = mean(SATM), 
            sd_SATM = sd(SATM),
            var_SATM= var(SATM),
            IQR = IQR(SATM), 
            n_rows = n(),
            quant_50_SATM = quantile(SATM, probs=c(0.5)),
            min = min(SATM),
            max= max(SATM),
            n_SATM = n_distinct(SATM))

#Summary Statistics of percent(percentage of graduating high school students who take S.A.T)
statesdata %>% 
  summarize(mean_percent = mean(percent), 
            sd_pop = sd(percent),
            var= var(percent),
            IQR = IQR(percent), 
            n_rows = n(),
            quants = quantile(percent, probs=c(.1, .25, .5, .75, .90)),
            min = min(percent),
            max= max(percent),
            n_pop = n_distinct(percent)) 
#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD percent per region
percent_data_grouped<- statesdata %>% 
  group_by(region)%>%
  summarize(mean_percent = mean(percent), 
            sd_percent = sd(percent),
            var_percent= var(percent),
            IQR = IQR(percent), 
            n_rows = n(),
            quants_50_percent = quantile(percent, probs=c(0.5)),
            min = min(percent),
            max= max(percent),
            n_percent = n_distinct(percent))
#Summary Statistics of  dollars(state spending on public education in $1000 per student)
statesdata %>% 
  summarize(mean_dollars = mean(dollars), 
            sd_dollars = sd(dollars),
            var= var(dollars),
            IQR = IQR(dollars), 
            n_rows = n(),
            quants = quantile(dollars, probs=c(.1, .25, .5, .75, .90)),
            min = min(dollars),
            max= max(dollars),
            n_dollars = n_distinct(dollars)) 

#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD dollars per region
dollars_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_dollars = mean(dollars), 
            sd_dollars = sd(dollars),
            var_dollars= var(dollars),
            IQR = IQR(dollars), 
            n_rows = n(),
            quants_50_dollars = quantile(dollars, probs=c(0.5)),
            min = min(dollars),
            max= max(dollars),
            n_dollars = n_distinct(dollars))
#Summary Statistics of pay:(average teachers salary)
statesdata %>% 
  summarize(mean_pay = mean(pay), 
            sd_pay = sd(pay),
            var= var(pay),
            IQR = IQR(pay), 
            n_rows = n(),
            quants = quantile(pay, probs=c(.1, .25, .5, .75, .90)),
            min = min(pay),
            max= max(pay),
            n_pay = n_distinct(pay)) 

#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD pay region
pay_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_pay = mean(pay), 
            sd_pay = sd(pay),
            var_pay= var(pay),
            IQR = IQR(pay), 
            n_rows = n(),
            quants_50_pay = quantile(pay, probs=c(0.5)),
            min = min(pay),
            max= max(pay),
            n_pay = n_distinct(pay))

#Summary Statistics of income estimate
statesdata %>% 
  summarize(mean_income_estimate = mean(income_estimate), 
            sd_income_estimate = sd(income_estimate),
            var= var(income_estimate),
            IQR = IQR(income_estimate), 
            n_rows = n(),
            quants = quantile(income_estimate, probs=c(.1, .25, .5, .75, .90)),
            min = min(income_estimate),
            max= max(income_estimate),
            n_income_estimate = n_distinct(income_estimate)) 

#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD income estimate region
income_estimate_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_income_estimate = mean(income_estimate), 
            sd_income_estimate = sd(income_estimate),
            var_income_estimate= var(income_estimate),
            IQR = IQR(income_estimate), 
            n_rows = n(),
            quants_50_income_estimate = quantile(income_estimate, probs=c(0.5)),
            min = min(income_estimate),
            max= max(income_estimate),
            n_income_estimate = n_distinct(income_estimate))
#Summary Statistics of rent estimate
statesdata %>% 
  summarize(mean_rent_estimate = mean(rent_estimate), 
            sd_rent_estimate = sd(rent_estimate),
            var= var(rent_estimate),
            IQR = IQR(rent_estimate), 
            n_rows = n(),
            quants = quantile(rent_estimate, probs=c(.1, .25, .5, .75, .90)),
            min = min(rent_estimate),
            max= max(rent_estimate),
            n_rent_estimate = n_distinct(rent_estimate)) 

#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD rent estimate region
rent_estimate_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_rent_estimate = mean(rent_estimate), 
            sd_rent_estimate = sd(rent_estimate),
            var_rent_estimate= var(rent_estimate),
            IQR = IQR(rent_estimate), 
            n_rows = n(),
            quants_50_rent_estimate = quantile(rent_estimate, probs=c(0.5)),
            min = min(rent_estimate),
            max= max(rent_estimate),
            n_rent_estimate = n_distinct(rent_estimate))

#Summary Statistics of income moe (Margin of Error)
statesdata %>% 
  summarize(mean_income_moe = mean(income_moe), 
            sd_income_moe = sd(income_moe),
            var= var(income_moe),
            IQR = IQR(income_moe), 
            n_rows = n(),
            quants = quantile(income_moe, probs=c(.1, .25, .5, .75, .90)),
            min = min(income_moe),
            max= max(income_moe),
            n_income_moe = n_distinct(income_moe)) 

#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD income moe (Margin of Error) estimate region
income_moe_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_income_moe = mean(income_moe), 
            sd_income_moe = sd(income_moe),
            var_income_moe= var(income_moe),
            IQR = IQR(income_moe), 
            n_rows = n(),
            quants_50_income_moe = quantile(income_moe, probs=c(0.5)),
            min = min(income_moe),
            max= max(income_moe),
            n_income_moe = n_distinct(income_moe))

#Summary Statistics of rent moe (Margin of Error)
statesdata %>% 
  summarize(mean_rent_moe = mean(rent_moe), 
            sd_rent_moe = sd(rent_moe),
            var= var(rent_moe),
            IQR = IQR(rent_moe), 
            n_rows = n(),
            quants = quantile(rent_moe, probs=c(.1, .25, .5, .75, .90)),
            min = min(rent_moe),
            max= max(rent_moe),
            n_rent_moe = n_distinct(rent_moe)) 

#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD rent moe (Margin of Error) estimate region
rent_moe_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_rent_moe = mean(rent_moe), 
            sd_rent_moe = sd(rent_moe),
            var_rent_moe= var(rent_moe),
            IQR = IQR(rent_moe), 
            n_rows = n(),
            quants_50_rent_moe = quantile(rent_moe, probs=c(0.5)),
            min = min(rent_moe),
            max= max(rent_moe),
            n_rent_moe = n_distinct(rent_moe))
#Summary Statistics of SAT Avg score
statesdata %>% 
  summarize(mean_SAT_avg = mean(SAT_avg), 
            sd_SAT_avg = sd(SAT_avg),
            var= var(SAT_avg),
            IQR = IQR(SAT_avg), 
            n_rows = n(),
            quants = quantile(SAT_avg, probs=c(.1, .25, .5, .75, .90)),
            min = min(SAT_avg),
            max= max(SAT_avg),
            n_SAT_avg = n_distinct(SAT_avg)) 
#Found Summary Statistics by subgroup of categorical variable region
#used group by to find the groups of data, and calculated mean and SD SAT_avg score per region
SAT_avg_data_grouped <- statesdata %>% 
  group_by(region)%>%
  summarize(mean_SAT_avg = mean(SAT_avg), 
            sd_SAT_avg = sd(SAT_avg),
            var_SAT_avg= var(SAT_avg),
            IQR = IQR(SAT_avg), 
            n_rows = n(),
            quants_50_SAT_avg = quantile(SAT_avg, probs=c(0.5)),
            min = min(SAT_avg),
            max= max(SAT_avg),
            n_SAT_avg = n_distinct(SAT_avg))




#cor function used for pairwise complete observation
# created correlation matrix for all numeric variables
states_num <- statesdata %>%
  select_if(is.numeric) 
correlation_matrix_states<- cor(states_num, use = "pairwise.complete.obs")
correlation_matrix_states




```





```{r, results='asis'}
#Easy to Read Tables using Kable
library(knitr)
library(kableExtra)

# Made 3 kable tables (split the numerical variables grouped by region accordingly)

#used cbind to combine some of the different data frames that were already grouped by region
statesdata_grouped <- cbind(pop_data_grouped, SAT_avg_data_grouped, income_estimate_data_grouped, rent_estimate_data_grouped) 
#selected only columns that included mean, sd ,quantile at the 50 percent mark due to size limitations
#applied kable function to organize its output in Rmd file and styled with striped
statesdata_grouped %>% select(1:3, 7, 12:13, 17) %>% kable(caption = "Summary Statistics of Population&SAT_avg,  per Region ") %>% kable_styling(bootstrap_options = "striped")

statesdata_grouped %>% select(22:23, 27, 32:33, 37) %>% kable(caption = "Summary Statistics of Income/Rent Estimate per Region ") %>% kable_styling(bootstrap_options = "striped")

#used cbind to combine some of the different data frames that were already grouped by region
statesdata_grouped2 <- cbind(dollars_data_grouped, pay_data_grouped, percent_data_grouped)

#selected only columns that included mean, sd , variance due to size limitations
#applied kable function to organize its output in Rmd file and styled with striped
statesdata_grouped2 %>% select(1:4, 12:14, 22:24) %>% kable(caption = "Summary Statistics of Dollars,Pay, Percent(percentage of graduating high school students who take S.A.T) per Region ") %>% kable_styling(bootstrap_options = "striped")
```

**Visualizations**
```{r}
# Make it pretty using a heatmap with geom_tile!
cor(states_num, use = "pairwise.complete.obs") %>%
  # Save as a data frame
  as.data.frame %>%
  # Convert row names to an explicit variable
  rownames_to_column %>%
  # Pivot so that all correlations appear in the same column
  pivot_longer(-1, names_to = "other_var", values_to = "correlation") %>%
  ggplot(aes(rowname, other_var, fill=correlation)) +
  # Heatmap with geom_tile
  geom_tile() +
  # Change the scale to make the middle appear neutral
  scale_fill_gradient2(low="red",mid="white",high="blue") +
  # Overlay values
  geom_text(aes(label = round(correlation,1.5)), color = "black", size = 4) +
  # Give title and labels
  labs(title = "Correlation matrix for the dataset statesdata", x = "variable 1", y = "variable 2")


library(ggplot2)

#2nd plot mapping 3 variables SAT_avg on x axis, income_estimate on y axis by region
#shows up as a line plot to see how SAT score changes across region and how it affects income estimate, 
#changed default color setting, and points were set to white color, with labels on axes added 
ggplot(data= statesdata, aes(x=SAT_avg, y=income_estimate, color=region)) + 
  geom_line()+
  scale_color_manual(values=c('red', 'orange','yellow','green','blue', 'purple','pink','magenta', 'coral')) +
  geom_point(colour="white", size=2) +
  ggtitle("Line plot of SAT_avg vs. income_estimate by region") + ylab("income estimate(in $1000 dollars)") + xlab("SAT_avg score")

#3rd plot mapping 3 variables Pay(average teachers salary) on x axis, dollars(state spending on public education in $1000 per student) on y axis by region
#shows up as a scatterplot with the data points and then summary is to showcase point ranges of error bars for each different region mean
#changed default colors using scale color brewer and added title and axes
ggplot(data = statesdata) +
  geom_pointrange(
    mapping = aes(x = pay, y = dollars, color=region),
    stat = "summary",
    fun.min = min,
    fun.max = max,
    fun = median
  ) +
  scale_color_brewer(palette = "Set1")+
  ggtitle("Scatterplot of Teacher's Pay vs.State Spending per Public School Student by Region") + xlab("pay:(average teachers salary)in dollars") + ylab("dollars(state spending on public education in $1000 per student)")




```
*Findings: The Visualizations correlation matrix disproved my hypothesis there Wasnâ€™t a strong correlation between SAT_avg and rent/income as predicted(-0.55). However, a higher SAT Score had a strong negative correlation with percent of students graduating from high school who took SAT(-0.87). My first ggplot of SAT avg vs income estimate grouped by region shows the disparity of education in each state even though region is similar. The second ggplot with stat=summary shows point error bars for the means of the region as a whole along with the individual data points. Its interesting to note that MA(Mid-Atlantic),NE(New England), and PAC (Pacific) region had some states with high dollars spent on a student's public education and higher teacher's salary  .*





**K-means/PAM Clustering**
```{r}
library(cluster)

#K-Means 
#Plotting the WSS against the number of clusters
wss <- vector()

# Find WSS for different values of k using a loop
for(i in 1:10){
temp <- states_num %>%
  select(pop,SATV, SATM, percent, dollars, pay,income_estimate, rent_estimate, income_moe, rent_moe, SAT_avg) %>%
  kmeans(.,i)
wss[i]<-temp$tot.withinss
}
# Represent the value of WSS depending on the number of clusters
ggplot() + 
  geom_point(aes(x=1:10,y=wss)) +
  geom_path(aes(x=1:10,y=wss)) +
  xlab("clusters") +
  scale_x_continuous(breaks=1:10)

#it was determined that 5 clusters were optimal for the all the numeric variables taken into account based on WSS against cluster test

# clustering on all the numeric variables in statesdata
clust_data <- states_num %>%
  select(pop,SATV, SATM, percent, dollars, pay,income_estimate, rent_estimate, income_moe, rent_moe, SAT_avg)
# Use the function kmeans to find 5 clusters
kmeans1 <- clust_data %>% kmeans(5)
kmeans1

# Save cluster assignment as a column in your dataset
kmeansclust <- clust_data %>%
  mutate(cluster=as.factor(kmeans1$cluster))

# Made 5 visualization plots comparing 2 variables (i.e. population vs. SAT_avg) colored by final cluster assignment to observe findings
kmeansclust %>%
  ggplot(aes(pop,SAT_avg, color = cluster)) +
  geom_point()+
  ggtitle("Cluster of Population vs.SAT_Avg")


kmeansclust %>%
  ggplot(aes(percent,pay, color = cluster)) +
  geom_point()+
  ggtitle("Cluster of Percent(percentage of graduating high school students who take S.A.T) vs.pay")


kmeansclust %>%
  ggplot(aes(income_estimate,rent_estimate, color = cluster)) +
  geom_point()+
  ggtitle("Cluster of Income estimate vs.Rent Estimate")


kmeansclust %>%
  ggplot(aes(pop,pay, color = cluster)) +
  geom_point()+
  ggtitle("Cluster of Population vs. Teachers Average Pay")


kmeansclust %>%
  ggplot(aes(SAT_avg,income_estimate, color = cluster)) +
  geom_point()+
  ggtitle("Cluster of SAT_Avg vs. Income Estimate")









#PAM Method

# Number of clusters based on silhouette width (how cohesive and separated clusters are, simultaneously) index takes inaccount WSS and BSS
# create an empty vector
sil_width <- vector()

# Find the silhouette width for different values of k using a loop
for(i in 2:10){  
  pam_fit <- pam(clust_data, k = i)
  sil_width[i] <- pam_fit$silinfo$avg.width  
}

# Represent the value of silhouette width depending on the number of clusters
ggplot() +
  geom_line(aes(x=1:10,y=sil_width)) +
  labs(x = "clusters", y = "silhouette width") +
  scale_x_continuous(breaks=1:10)

#highest silhouette width is 6 clusters

# Use the function pam to find 6 clusters
pam1 <- clust_data %>%
  pam(k=6)
pam1

# Save cluster assignment as a column in your dataset
pamclust <- clust_data %>%
  mutate(cluster = as.factor(pam1$clustering))

# Make a plot of data colored by final cluster assignment
pamclust %>% 
  ggplot(aes(pop,SAT_avg,color = cluster)) +
  geom_point()

# Calculate the means of each variable for each cluster
pamclust %>% 
  group_by(cluster) %>%
  summarize_if(is.numeric,~ mean(.x, na.rm=T))

# Find the observations that are the final medoids
statesdata[pam1$id.med,]
```


*Findings: From the K-means plots, the population vs SAT_Avg it further confirms that a higher population can have a lower SAT_avg score, generally the less students who can graduate who took SAT can perform better. The third plot of income vs rent estimate shows the moderate cluster relationship between those, there is still regions of overlap. The fourth plot shows a weak relationship between pay and population, as it appears as vertical cluster. The fifth cluster of income estimate vs SAT_Avg shows weak cluster relationship. The other pam cluster is similar to 1st K-means plot and shows similar results. THe pam observations below indicate which serve states best as medoids. *
